// app/api/line/webhook/route.ts
import { NextRequest, NextResponse } from "next/server";
import {
  verifyLineSignature,
  lineReplyMessages,
  lineReplyText,
  buildPromoFlex,
  buildCreditHelpFlex,
  LineMessage,
} from "@/lib/line";
import { buildPromoReplyFromText, promoSummary } from "@/lib/promos";
import { askAI } from "@/lib/ai";
import { trackUserId } from "@/lib/users";
import { checkRateLimit } from "@/lib/rate-limit";
import { validateAIResponse, sanitizeResponse } from "@/lib/response-validator";
import { findQuickResponse, getQuickResponse } from "@/lib/quick-responses";

export const runtime = "nodejs"; // ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Node ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô HMAC

const BRAND_NAME = process.env.BRAND_NAME ?? "‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏≠‡∏ó‡∏Ñ‡∏≠‡∏°";
const LINE_HANDLE = process.env.LINE_OA_HANDLE ?? "@mechoke";
const SIGNUP_URL = process.env.SIGNUP_URL || "https://www.mechoke.com/";

/** ---------------- Admin-only: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà "‡∏ö‡∏≠‡∏ó‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö" ----------------
 * ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ö‡∏≠‡∏ó
 * ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏°‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡∏ö‡∏≠‡∏ó‡∏à‡∏∞ "‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö" (skip)
 */
const ADMIN_ONLY_PHRASES = [
  "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
  "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
  "‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Æ‡∏á‡πÜ ‡∏õ‡∏±‡∏á‡πÜ",
  "‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô",
  "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß",
  "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
];

/** ---------------- Sensitive: ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô/‡∏¢‡∏π‡∏™/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ----------------
 * ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ AI ‡∏ï‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
 */
const SENSITIVE_KEYWORDS = [
  "‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",
  "‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",
  "‡∏à‡∏≥‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ",
  "‡∏•‡∏∑‡∏°‡∏¢‡∏π‡∏™",
  "‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå",
  "‡∏Ç‡∏≠‡∏¢‡∏π‡∏™",
  "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™",
  "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£",
  "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå",
];

/** ---------------- Quick Router: ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡πÄ‡∏ü‡∏•‡πá‡∏Å‡∏ã‡πå ---------------- */
function routeQuickAnswerToMessages(text: string): LineMessage[] | null {
  const t = (text || "").trim().toLowerCase();

  // üéØ ‡∏•‡∏≠‡∏á match ‡∏à‡∏≤‡∏Å Quick Response Library ‡∏Å‡πà‡∏≠‡∏ô
  const quickResp = findQuickResponse(text);
  if (quickResp) {
    console.info("[quick-response] matched:", quickResp.key);
    return [{ type: "text", text: quickResp.text }];
  }

  // ‡∏Ç‡∏≠ "‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£" ‚Üí ‡∏™‡πà‡∏á Flex ‡πÇ‡∏õ‡∏£‡∏†‡∏≤‡∏û
  if (/(‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£|‡πÇ‡∏õ‡∏£‡∏†‡∏≤‡∏û|promotion image|‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏π‡∏õ)/i.test(t)) {
    return [buildPromoFlex({ ctaUrl: SIGNUP_URL })];
  }

  // ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô
  if (/(‡πÇ‡∏õ‡∏£|promotion|‡πÇ‡∏õ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ|‡πÇ‡∏õ‡∏£ ‡∏û‡∏¥‡πÄ‡∏®‡∏©|‡∏ù‡∏≤‡∏Å 300|‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°|‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô|vip)/i.test(t)) {
    if (/(‡πÇ‡∏õ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ|‡πÇ‡∏õ‡∏£ ‡∏û‡∏¥‡πÄ‡∏®‡∏©|‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á|promotion)/i.test(t)) {
      return [{ type: "text", text: promoSummary() }];
    }
    const reply = buildPromoReplyFromText(text);
    if (reply) return [{ type: "text", text: reply }];
  }

  // ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤
  if (/(‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï|‡πÄ‡∏á‡∏¥‡∏ô|‡∏¢‡∏≠‡∏î).*(‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤|‡πÑ‡∏°‡πà‡∏°‡∏≤|‡∏´‡∏≤‡∏¢|‡∏Ñ‡πâ‡∏≤‡∏á)/i.test(t)) {
    return [
      buildCreditHelpFlex(),
      {
        type: "text",
        text: [
          "ü§ñ ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡πà‡∏∞",
          "‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞",
          "",
          "üìù ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡πà‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£:",
          "‚Ä¢ ‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",
          "‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô",
          "‚Ä¢ ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤/‡∏™‡∏•‡∏¥‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)",
          "",
          `üí¨ ‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ó‡∏µ‡πà: ${LINE_HANDLE}`,
          "‚è±Ô∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5-15 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞",
        ].join("\n"),
      },
    ];
  }

  // ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
  if (/(‡∏™‡∏°‡∏±‡∏Ñ‡∏£|regis|register)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‚ú®",
          `‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${SIGNUP_URL}`,
          "‡∏ù‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞ üéÅ",
        ].join("\n"),
      },
    ];
  }

  // ‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
  if (/(‡∏ñ‡∏≠‡∏ô|withdraw).*(‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|min|‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥)/i.test(t)) {
    return [{ type: "text", text: "ü§ñ ‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 24 ‡∏ä‡∏°. ‚è±Ô∏è" }];
  }

  // ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ß‡∏¥‡∏ò‡∏µ/‡πÄ‡∏ß‡∏•‡∏≤/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)
  if (/(‡∏ñ‡∏≠‡∏ô|withdraw)/i.test(t)) {
    if (/(‡∏ß‡∏¥‡∏ò‡∏µ‡∏ñ‡∏≠‡∏ô|‡∏ñ‡∏≠‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏ñ‡∏≠‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)/i.test(t)) {
      return [
        {
          type: "text",
          text: [
            "ü§ñ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:",
            "1) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
            "2) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'",
            "3) ‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
            "‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 24 ‡∏ä‡∏°. ‚è±Ô∏è",
          ].join("\n"),
        },
      ];
    }
    if (/(‡∏ô‡∏≤‡∏ô|‡πÄ‡∏ß‡∏•‡∏≤|‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ|‡∏Å‡∏µ‡πà‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)/i.test(t)) {
      return [{ type: "text", text: "ü§ñ ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 24 ‡∏ä‡∏°. ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ñ‡πà‡∏∞ ‚è±Ô∏è" }];
    }
  }

  // ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô (‡∏ß‡∏¥‡∏ò‡∏µ/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)
  if (/(‡∏ù‡∏≤‡∏Å|deposit)/i.test(t)) {
    if (/(‡∏ß‡∏¥‡∏ò‡∏µ‡∏ù‡∏≤‡∏Å|‡∏ù‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏ù‡∏≤‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£|‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á)/i.test(t)) {
      return [
        {
          type: "text",
          text: [
            "ü§ñ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô:",
            "1) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
            "2) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π '‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô'",
            "3) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ó‡∏£‡∏π‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡πá‡∏ó)",
            "4) ‡πÇ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ",
            "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï 1-5 ‡∏ô‡∏≤‡∏ó‡∏µ ‚ö°",
          ].join("\n"),
        },
      ];
    }
    if (/(‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|min|‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥|maximum|max|‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á)/i.test(t)) {
      return [
        {
          type: "text",
          text: [
            "ü§ñ ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô:",
            "‚Ä¢ ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: 100 ‡∏ö‡∏≤‡∏ó",
            "‚Ä¢ ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥",
          ].join("\n"),
        },
      ];
    }
  }

  // ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  if (/(‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ|‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô|‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô|‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:",
          "1) ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
          "2) ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô",
          "3) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç",
          "4) ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏ú‡∏•‡∏≠‡∏≠‡∏Å",
          "5) ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏ú‡∏•",
          `‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${SIGNUP_URL}`,
        ].join("\n"),
      },
    ];
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏¢‡∏≠‡∏î/‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
  if (/(‡∏¢‡∏≠‡∏î|‡πÄ‡∏á‡∏¥‡∏ô|‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï|balance|‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î|‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô:",
          "‚Ä¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡∏¢‡∏≠‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å/‡πÄ‡∏°‡∏ô‡∏π '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô'",
          "‚Ä¢ ‡∏´‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞",
        ].join("\n"),
      },
    ];
  }

  // ‡∏™‡∏•‡∏¥‡∏õ/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÇ‡∏≠‡∏ô
  if (/(‡∏™‡∏•‡∏¥‡∏õ|‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô|‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î|upload)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏•‡∏¥‡∏õ:",
          "‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π '‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô'",
          "‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à 1-5 ‡∏ô‡∏≤‡∏ó‡∏µ",
          "‚Ä¢ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞",
        ].join("\n"),
      },
    ];
  }

  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢/‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  if (/(‡∏ä‡πà‡∏ß‡∏¢|‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠|‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°|faq|help|‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡πà‡∏∞",
          "",
          "üìå ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢:",
          "‚Ä¢ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏™‡∏°‡∏±‡∏Ñ‡∏£'",
          "‚Ä¢ ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏ù‡∏≤‡∏Å'",
          "‚Ä¢ ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏ñ‡∏≠‡∏ô'",
          "‚Ä¢ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡πÇ‡∏õ‡∏£'",
          "‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏ú‡∏•: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡πÄ‡∏ß‡∏•‡∏≤'",
          "‚Ä¢ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ'",
          "",
          `üë§ ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç/‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤
  if (/(‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç|‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î|‡∏Å‡∏é|‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤|terms|condition)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏•‡∏±‡∏Å:",
          "‚Ä¢ ‡∏≠‡∏≤‡∏¢‡∏∏ 18+ ‡∏õ‡∏µ",
          "‚Ä¢ 1 ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡πà‡∏≠ 1 ‡∏Ñ‡∏ô ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á",
          "‚Ä¢ ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ã‡πâ‡∏≠‡∏ô",
          `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${SIGNUP_URL}`,
        ].join("\n"),
      },
    ];
  }

  // VIP/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
  if (/(vip|‡∏ß‡∏µ‡πÑ‡∏≠‡∏û‡∏µ|‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å|‡∏£‡∏∞‡∏î‡∏±‡∏ö|‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô|point|bonus)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å VIP:",
          "‚Ä¢ ‡∏™‡∏∞‡∏™‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©",
          "‚Ä¢ ‡πÇ‡∏õ‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
          "‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢",
        ].join("\n"),
      },
    ];
  }

  // ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
  if (/(‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠|‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô|admin|contact|‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:",
          `‚Ä¢ LINE OA: ${LINE_HANDLE}`,
          "‚Ä¢ ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 24 ‡∏ä‡∏°. ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏ß",
        ].join("\n"),
      },
    ];
  }

  // ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö/‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ/‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
  if (/(‡∏£‡∏∞‡∏ö‡∏ö|‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå|‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ|‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô|login|‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:",
          "‚Ä¢ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå",
          "‚Ä¢ ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä",
          "‚Ä¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï",
          "",
          "‚ö†Ô∏è ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:",
          `üë§ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
  if (/(‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ|hello|hi|hey|‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ|‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö|‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ü§ñ",
          `‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ" (‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ AI)`,
          `‡∏Ç‡∏≠‡∏á ${BRAND_NAME}`,
          "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞",
          "",
          "üìù ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô:",
          "‚Ä¢ '‡∏™‡∏°‡∏±‡∏Ñ‡∏£' '‡πÇ‡∏õ‡∏£' '‡∏ù‡∏≤‡∏Å' '‡∏ñ‡∏≠‡∏ô'",
          "‚Ä¢ '‡πÄ‡∏ß‡∏•‡∏≤' '‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ' '‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠'",
          "",
          `üë§ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏ú‡∏•/‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö (‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
  if (/(‡∏´‡∏ß‡∏¢|‡∏•‡∏≤‡∏ß|‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢|‡∏´‡∏∏‡πâ‡∏ô|‡πÄ‡∏ß‡∏•‡∏≤|‡∏≠‡∏≠‡∏Å‡∏ú‡∏•|‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏ú‡∏• (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á):",
          "‚Ä¢ ‡∏•‡∏≤‡∏ß‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á 12:30 ‡∏ô.",
          "‚Ä¢ ‡∏•‡∏≤‡∏ß‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ 15:00 ‡∏ô.",
          "‚Ä¢ ‡∏•‡∏≤‡∏ß‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤ 17:30 ‡∏ô.",
          "‚Ä¢ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥ 18:30 ‡∏ô.",
          "‚Ä¢ ‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏ó‡∏¢‡∏£‡∏≠‡∏ö‡∏ö‡πà‡∏≤‡∏¢ 16:30 ‡∏ô.",
        ].join("\n"),
      },
    ];
  }

  // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢/‡πÇ‡∏Å‡∏á/‡∏õ‡∏•‡∏≠‡∏°
  if (/(‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢|‡πÇ‡∏Å‡∏á|‡∏´‡∏•‡∏≠‡∏Å‡∏•‡∏ß‡∏á|‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢|scam|‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô|‡∏´‡∏ô‡∏µ|‡∏õ‡∏•‡∏≠‡∏°)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          `üîí ${BRAND_NAME} ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢`,
          "‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ù‡∏≤‡∏Å-‡∏ñ‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥",
          "‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™",
          "‚Ä¢ ‡∏°‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏• 24 ‡∏ä‡∏°.",
          "",
          "‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ:",
          `LINE: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
  if (/(‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô|‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å|refund|‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î|‡πÅ‡∏ó‡∏á‡∏ú‡∏¥‡∏î|‡∏Å‡∏î‡∏ú‡∏¥‡∏î)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡πà‡∏∞",
          "",
          "‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:",
          "‚Ä¢ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏á‡∏ß‡∏î‡∏õ‡∏¥‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô",
          "‚Ä¢ ‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏ß‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ",
          "",
          "üìù ‡∏Å‡∏£‡∏ì‡∏µ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á:",
          "‚Ä¢ ‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå",
          "‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤",
          "‚Ä¢ ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)",
          "",
          `üí¨ ‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà: ${LINE_HANDLE}`,
          "‚è±Ô∏è ‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5-10 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞",
        ].join("\n"),
      },
    ];
  }

  // ‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤/‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô
  if (/(‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤|‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô|‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô|‡∏î‡πà‡∏ß‡∏ô|urgent|complaint)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "üö® ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏∞",
          "‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞",
          "",
          "üìù ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:",
          "‚Ä¢ ‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",
          "‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô",
          "‚Ä¢ ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (‡∏™‡∏•‡∏¥‡∏õ/‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)",
          "",
          `üí¨ ‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà: ${LINE_HANDLE}`,
          "‚è±Ô∏è ‡πÄ‡∏Ñ‡∏™‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 3-5 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞",
          "",
          "üíö ‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞",
        ].join("\n"),
      },
    ];
  }

  // ‡∏Ç‡∏≠‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î/‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢/‡∏î‡∏ß‡∏á ‚Üí ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò
  if (/(‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î|‡πÄ‡∏•‡∏Ç‡∏î‡∏±‡∏á|‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢|‡∏ó‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç|‡∏î‡∏ß‡∏á|‡πÇ‡∏ä‡∏Ñ‡∏•‡∏≤‡∏†|‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏•‡∏Ç)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "ü§ñ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î/‡∏î‡∏ß‡∏á/‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢:",
          "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•",
          "AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞",
          "",
          "üåü ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:",
          "‚Ä¢ ‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πá‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ",
          "‚Ä¢ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö/‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á",
          "‚Ä¢ ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏ï‡∏±‡∏ß‡∏Ñ‡πà‡∏∞",
        ].join("\n"),
      },
    ];
  }

  return null; // ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ Intent ‚Üí ‡πÉ‡∏´‡πâ Fallback ‡πÑ‡∏õ ChatGPT
}

/** ---------------- Helpers ---------------- */
function includesAny(text: string, list: string[]): boolean {
  const s = (text || "").toLowerCase();
  return list.some((kw) => s.includes(kw.toLowerCase()));
}

/** ---------------- POST: LINE Webhook ---------------- */
export async function POST(req: NextRequest) {
  const signature = req.headers.get("x-line-signature") || undefined;
  const rawBody = await req.text();

  // Production: ‡∏ï‡∏£‡∏ß‡∏à‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô, Dev: ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏™‡∏á‡πà‡∏≤‡∏¢
  const isDev = process.env.NODE_ENV !== "production";
  if (!isDev) {
    const ok = verifyLineSignature(rawBody, signature);
    if (!ok) return NextResponse.json({ error: "Invalid signature" }, { status: 401 });
  }

  const body = JSON.parse(rawBody || "{}");
  const events: any[] = body.events ?? [];

  for (const e of events) {
    // ‡πÄ‡∏Å‡πá‡∏ö userId/roomId/groupId ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö debug & push console (‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏≠‡∏Å try ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô catch)
    const uid =
      e?.source?.userId || e?.source?.roomId || e?.source?.groupId || undefined;

    try {
      if (uid) trackUserId(uid).catch(() => {});

      // Rate limiting: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô message flooding (20 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏ó‡∏µ)
      if (uid) {
        const rateLimitResult = checkRateLimit(uid, { maxRequests: 20, windowMs: 60000 });
        if (!rateLimitResult.allowed) {
          console.warn("[rate-limit] User exceeded limit:", {
            userId: uid.substring(0, 12) + "...",
            remaining: rateLimitResult.remaining,
          });
          // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≤‡∏°
          await lineReplyText(
            e.replyToken,
            "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏∏‡∏ì‡∏û‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞ üôè"
          ).catch(() => {});
          continue;
        }
      }

      // ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ text message
      if (e.type !== "message" || e.message?.type !== "text") continue;

      const userText: string = e.message.text || "";
      // PRIVACY: ‡πÑ‡∏°‡πà log ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏° ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ metadata
      console.info("[webhook] received text message:", {
        userId: uid?.substring(0, 8) + "...",
        length: userText.length
      });

      // 0) Admin-only phrases ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö (‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
      if (includesAny(userText, ADMIN_ONLY_PHRASES)) {
        console.info("[skip] admin-only phrase detected. no bot reply.");
        continue;
      }

      // 1) Sensitive (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô/‡∏¢‡∏π‡∏™/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£) ‚Üí ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      if (includesAny(userText, SENSITIVE_KEYWORDS)) {
        console.info("[reply] via Sensitive/Admin script");
        await lineReplyMessages(e.replyToken, [
          {
            type: "text",
            text: [
              "ü§ñ ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡πà‡∏∞",
              "",
              "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå/‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß",
              "‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏Ñ‡πà‡∏∞ üîí",
              "",
              "üìù ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô:",
              "‚Ä¢ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô",
              "‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÑ‡∏î‡πâ)",
              "‚Ä¢ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤",
              "",
              `üí¨ ‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ó‡∏µ‡πà: ${LINE_HANDLE}`,
              "‚è±Ô∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5-10 ‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Ñ‡πà‡∏∞",
              "",
              "üíö ‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞",
            ].join("\n"),
          },
        ]);
        continue;
      }

      // 2) Intent router
      const intentMsgs = routeQuickAnswerToMessages(userText);
      if (intentMsgs && intentMsgs.length > 0) {
        console.info("[reply] via Router/Intent");
        await lineReplyMessages(e.replyToken, intentMsgs);
        continue;
      }

      // 3) Fallback ‚Üí ChatGPT (‡∏û‡∏£‡πâ‡∏≠‡∏° confidence check)
      console.info("[reply] via ChatGPT Fallback");
      const aiResult = await askAI(userText, {
        brandName: BRAND_NAME,
        lineHandle: LINE_HANDLE,
      });

      // Log AI decision ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö monitoring
      console.info("[ai-decision]", {
        shouldEscalate: aiResult.shouldEscalate,
        confidence: aiResult.confidence,
        responseLength: aiResult.response.length,
      });

      // Validate ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î)
      const validation = validateAIResponse(aiResult.response);
      if (!validation.isValid) {
        console.warn("[ai-validation-failed]", {
          reason: validation.reason,
          originalResponse: aiResult.response.substring(0, 100) + "...",
        });

        // ‡∏ñ‡πâ‡∏≤ validation ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‚Üí ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏™‡∏°‡∏≠
        const safeMsg = [
          "ü§ñ ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡πà‡∏∞",
          "",
          "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô",
          "‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞",
          "",
          `üí¨ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà: ${LINE_HANDLE}`,
          "‚è±Ô∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10-15 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞",
          "",
          "üíö ‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡πà‡∏∞",
        ].join("\n");

        await lineReplyText(e.replyToken, safeMsg);
        continue;
      }

      // ‡∏ñ‡πâ‡∏≤ AI ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
      if (aiResult.shouldEscalate || aiResult.confidence === "low") {
        const escalateMsg = [
          sanitizeResponse(aiResult.response),
          "",
          "‚ÑπÔ∏è ‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞",
          `üí¨ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà: ${LINE_HANDLE}`,
          "‚è±Ô∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 10-15 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞",
        ].join("\n");

        await lineReplyText(e.replyToken, escalateMsg);
        continue;
      }

      // confidence = medium/high ‚Üí ‡∏ï‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ú‡πà‡∏≤‡∏ô sanitizer)
      const finalText = sanitizeResponse(aiResult.response.trim()) || "‡∏ô‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üôè";
      await lineReplyText(e.replyToken, finalText);
    } catch (err) {
      // ‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
      try {
        await lineReplyText(
          e.replyToken,
          "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üôè"
        );
      } catch (replyErr) {
        console.error("[webhook] Failed to send error reply:", replyErr);
      }

      // Log error with context
      console.error("[webhook error]", {
        error: err instanceof Error ? err.message : String(err),
        stack: err instanceof Error ? err.stack : undefined,
        userId: uid?.substring(0, 12) + "...",
        eventType: e.type,
        timestamp: new Date().toISOString(),
      });
    }
  }

  return NextResponse.json({ ok: true });
}

/** ---------------- GET: Health ---------------- */
export function GET() {
  return NextResponse.json({
    ok: true,
    brand: BRAND_NAME,
    handle: LINE_HANDLE,
    hint: "LINE ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å endpoint ‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ POST ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô",
  });
}