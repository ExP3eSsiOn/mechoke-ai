// app/api/line/webhook/route.ts
import { NextRequest, NextResponse } from "next/server";
import {
  verifyLineSignature,
  lineReplyMessages,
  lineReplyText,
  buildPromoFlex,
  buildCreditHelpFlex,
  LineMessage,
} from "@/lib/line";
import { buildPromoReplyFromText, promoSummary } from "@/lib/promos";
import { askAI } from "@/lib/ai";
import { trackUserId } from "@/lib/users";

export const runtime = "nodejs"; // ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Node ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô HMAC

const BRAND_NAME = process.env.BRAND_NAME ?? "‡∏°‡∏µ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏≠‡∏ó‡∏Ñ‡∏≠‡∏°";
const LINE_HANDLE = process.env.LINE_OA_HANDLE ?? "@mechoke";
const SIGNUP_URL = process.env.SIGNUP_URL || "https://www.mechoke.com/";

/** ---------------- Admin-only: ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà "‡∏ö‡∏≠‡∏ó‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö" ----------------
 * ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ö‡∏≠‡∏ó
 * ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏°‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡∏ö‡∏≠‡∏ó‡∏à‡∏∞ "‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö" (skip)
 */
const ADMIN_ONLY_PHRASES = [
  "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
  "‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
  "‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Æ‡∏á‡πÜ ‡∏õ‡∏±‡∏á‡πÜ",
  "‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô",
  "‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß",
  "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
];

/** ---------------- Sensitive: ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô/‡∏¢‡∏π‡∏™/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ ----------------
 * ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ AI ‡∏ï‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
 */
const SENSITIVE_KEYWORDS = [
  "‡∏Ç‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",
  "‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",
  "‡∏à‡∏≥‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ",
  "‡∏•‡∏∑‡∏°‡∏¢‡∏π‡∏™",
  "‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå",
  "‡∏Ç‡∏≠‡∏¢‡∏π‡∏™",
  "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™",
  "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£",
  "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå",
];

/** ---------------- Quick Router: ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡πÄ‡∏ü‡∏•‡πá‡∏Å‡∏ã‡πå ---------------- */
function routeQuickAnswerToMessages(text: string): LineMessage[] | null {
  const t = (text || "").trim().toLowerCase();

  // ‡∏Ç‡∏≠ "‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£" ‚Üí ‡∏™‡πà‡∏á Flex ‡πÇ‡∏õ‡∏£‡∏†‡∏≤‡∏û
  if (/(‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£|‡πÇ‡∏õ‡∏£‡∏†‡∏≤‡∏û|promotion image|‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏π‡∏õ)/i.test(t)) {
    return [buildPromoFlex({ ctaUrl: SIGNUP_URL })];
  }

  // ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô
  if (/(‡πÇ‡∏õ‡∏£|promotion|‡πÇ‡∏õ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ|‡πÇ‡∏õ‡∏£ ‡∏û‡∏¥‡πÄ‡∏®‡∏©|‡∏ù‡∏≤‡∏Å 300|‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°|‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô|vip)/i.test(t)) {
    if (/(‡πÇ‡∏õ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ|‡πÇ‡∏õ‡∏£ ‡∏û‡∏¥‡πÄ‡∏®‡∏©|‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á|promotion)/i.test(t)) {
      return [{ type: "text", text: promoSummary() }];
    }
    const reply = buildPromoReplyFromText(text);
    if (reply) return [{ type: "text", text: reply }];
  }

  // ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤
  if (/(‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï|‡πÄ‡∏á‡∏¥‡∏ô|‡∏¢‡∏≠‡∏î).*(‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤|‡πÑ‡∏°‡πà‡∏°‡∏≤|‡∏´‡∏≤‡∏¢|‡∏Ñ‡πâ‡∏≤‡∏á)/i.test(t)) {
    return [
      buildCreditHelpFlex(),
      {
        type: "text",
        text: [
          "‡∏ô‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ô‡∏∞‡∏Ñ‡∏∞ üôè",
          "‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á '‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£' + '‡πÄ‡∏ß‡∏•‡∏≤/‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å' + '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏™‡∏•‡∏¥‡∏õ‡∏¢‡πà‡∏≠'",
          `‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß‡∏Ñ‡πà‡∏∞ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
  if (/(‡∏™‡∏°‡∏±‡∏Ñ‡∏£|regis|register)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‚ú®",
          `‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${SIGNUP_URL}`,
          "‡∏ù‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏°‡∏ü‡∏£‡∏µ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏Ñ‡πà‡∏∞ üéÅ",
        ].join("\n"),
      },
    ];
  }

  // ‡∏ñ‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
  if (/(‡∏ñ‡∏≠‡∏ô|withdraw).*(‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|min|‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥)/i.test(t)) {
    return [{ type: "text", text: "‡∏ñ‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 100 ‡∏ö‡∏≤‡∏ó‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 24 ‡∏ä‡∏°. ‚è±Ô∏è" }];
  }

  // ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ß‡∏¥‡∏ò‡∏µ/‡πÄ‡∏ß‡∏•‡∏≤/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)
  if (/(‡∏ñ‡∏≠‡∏ô|withdraw)/i.test(t)) {
    if (/(‡∏ß‡∏¥‡∏ò‡∏µ‡∏ñ‡∏≠‡∏ô|‡∏ñ‡∏≠‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏ñ‡∏≠‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£)/i.test(t)) {
      return [
        {
          type: "text",
          text: [
            "üìù ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:",
            "1) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
            "2) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π '‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'",
            "3) ‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
            "‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 24 ‡∏ä‡∏°. ‚è±Ô∏è",
            `‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${LINE_HANDLE}`,
          ].join("\n"),
        },
      ];
    }
    if (/(‡∏ô‡∏≤‡∏ô|‡πÄ‡∏ß‡∏•‡∏≤|‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ|‡∏Å‡∏µ‡πà‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)/i.test(t)) {
      return [{ type: "text", text: "‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 24 ‡∏ä‡∏°. ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ñ‡πà‡∏∞ ‚è±Ô∏è" }];
    }
  }

  // ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô (‡∏ß‡∏¥‡∏ò‡∏µ/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç)
  if (/(‡∏ù‡∏≤‡∏Å|deposit)/i.test(t)) {
    if (/(‡∏ß‡∏¥‡∏ò‡∏µ‡∏ù‡∏≤‡∏Å|‡∏ù‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡∏ù‡∏≤‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£|‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á)/i.test(t)) {
      return [
        {
          type: "text",
          text: [
            "üìù ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô:",
            "1) ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
            "2) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π '‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô'",
            "3) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á (‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ó‡∏£‡∏π‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡πá‡∏ó)",
            "4) ‡πÇ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ",
            "‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï 1-5 ‡∏ô‡∏≤‡∏ó‡∏µ ‚ö°",
            `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${LINE_HANDLE}`,
          ].join("\n"),
        },
      ];
    }
    if (/(‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà|min|‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥|maximum|max|‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á)/i.test(t)) {
      return [
        {
          type: "text",
          text: [
            "üí≥ ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô:",
            "‚Ä¢ ‡∏ù‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥: 100 ‡∏ö‡∏≤‡∏ó",
            "‚Ä¢ ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥",
            `‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${LINE_HANDLE}`,
          ].join("\n"),
        },
      ];
    }
  }

  // ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  if (/(‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ|‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏•‡πà‡∏ô|‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á|‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô|‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:",
          "1) ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
          "2) ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô",
          "3) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç",
          "4) ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠ ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏ú‡∏•‡∏≠‡∏≠‡∏Å",
          "5) ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏ú‡∏•",
          `‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${SIGNUP_URL}`,
          `‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏¢‡∏≠‡∏î/‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
  if (/(‡∏¢‡∏≠‡∏î|‡πÄ‡∏á‡∏¥‡∏ô|‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï|balance|‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î|‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "üí∞ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô:",
          "‚Ä¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏î‡∏π‡∏¢‡∏≠‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å/‡πÄ‡∏°‡∏ô‡∏π '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô'",
          "‚Ä¢ ‡∏´‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞",
          `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡∏™‡∏•‡∏¥‡∏õ/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÇ‡∏≠‡∏ô
  if (/(‡∏™‡∏•‡∏¥‡∏õ|‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô|‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î|upload)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "üì∏ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏•‡∏¥‡∏õ:",
          "‚Ä¢ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π '‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô'",
          "‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à 1-5 ‡∏ô‡∏≤‡∏ó‡∏µ",
          "‚Ä¢ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞",
          `LINE OA: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢/‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  if (/(‡∏ä‡πà‡∏ß‡∏¢|‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠|‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°|faq|help|‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "üôã ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢:",
          "‚Ä¢ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏™‡∏°‡∏±‡∏Ñ‡∏£'",
          "‚Ä¢ ‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏ù‡∏≤‡∏Å'",
          "‚Ä¢ ‡∏ñ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏ñ‡∏≠‡∏ô'",
          "‚Ä¢ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡πÇ‡∏õ‡∏£'",
          "‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏ú‡∏•: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡πÄ‡∏ß‡∏•‡∏≤'",
          "‚Ä¢ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ'",
          `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏ó‡∏±‡∏Å: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç/‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤
  if (/(‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç|‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î|‡∏Å‡∏é|‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤|terms|condition)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "üìã ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏•‡∏±‡∏Å:",
          "‚Ä¢ ‡∏≠‡∏≤‡∏¢‡∏∏ 18+ ‡∏õ‡∏µ",
          "‚Ä¢ 1 ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡πà‡∏≠ 1 ‡∏Ñ‡∏ô ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á",
          "‚Ä¢ ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ã‡πâ‡∏≠‡∏ô",
          `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${SIGNUP_URL}`,
        ].join("\n"),
      },
    ];
  }

  // VIP/‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
  if (/(vip|‡∏ß‡∏µ‡πÑ‡∏≠‡∏û‡∏µ|‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å|‡∏£‡∏∞‡∏î‡∏±‡∏ö|‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô|point|bonus)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "üëë ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å VIP:",
          "‚Ä¢ ‡∏™‡∏∞‡∏™‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏¥‡πÄ‡∏®‡∏©",
          "‚Ä¢ ‡πÇ‡∏õ‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å",
          "‚Ä¢ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢",
          `‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÇ‡∏õ‡∏£ VIP: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
  if (/(‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠|‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô|admin|contact|‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô:",
          `‚Ä¢ LINE OA: ${LINE_HANDLE}`,
          "‚Ä¢ ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 24 ‡∏ä‡∏°. ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏ß",
        ].join("\n"),
      },
    ];
  }

  // ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö/‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ/‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
  if (/(‡∏£‡∏∞‡∏ö‡∏ö|‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå|‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ|‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô|login|‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "üîß ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:",
          "‚Ä¢ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå",
          "‚Ä¢ ‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ä",
          "‚Ä¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï",
          `‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
  if (/(‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ|hello|hi|hey|‡∏´‡∏ß‡∏±‡∏î‡∏î‡∏µ|‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö|‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏ß‡∏¢‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå üéâ",
          "‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏™‡∏°‡∏±‡∏Ñ‡∏£', '‡πÇ‡∏õ‡∏£', '‡∏ù‡∏≤‡∏Å', '‡∏ñ‡∏≠‡∏ô', '‡πÄ‡∏ß‡∏•‡∏≤', '‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞",
          `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  // ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏ú‡∏•/‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö (‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
  if (/(‡∏´‡∏ß‡∏¢|‡∏•‡∏≤‡∏ß|‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢|‡∏´‡∏∏‡πâ‡∏ô|‡πÄ‡∏ß‡∏•‡∏≤|‡∏≠‡∏≠‡∏Å‡∏ú‡∏•|‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö)/i.test(t)) {
    return [
      {
        type: "text",
        text: [
          "‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏ú‡∏• (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á):",
          "‚Ä¢ ‡∏•‡∏≤‡∏ß‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á 12:30 ‡∏ô.",
          "‚Ä¢ ‡∏•‡∏≤‡∏ß‡∏™‡∏ö‡∏≤‡∏¢‡∏î‡∏µ 15:00 ‡∏ô.",
          "‚Ä¢ ‡∏•‡∏≤‡∏ß‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤ 17:30 ‡∏ô.",
          "‚Ä¢ ‡∏Æ‡∏≤‡∏ô‡∏≠‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥ 18:30 ‡∏ô.",
          "‚Ä¢ ‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏ó‡∏¢‡∏£‡∏≠‡∏ö‡∏ö‡πà‡∏≤‡∏¢ 16:30 ‡∏ô.",
          `‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà ${LINE_HANDLE}`,
        ].join("\n"),
      },
    ];
  }

  return null; // ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ Intent ‚Üí ‡πÉ‡∏´‡πâ Fallback ‡πÑ‡∏õ ChatGPT
}

/** ---------------- Helpers ---------------- */
function includesAny(text: string, list: string[]): boolean {
  const s = (text || "").toLowerCase();
  return list.some((kw) => s.includes(kw.toLowerCase()));
}

/** ---------------- POST: LINE Webhook ---------------- */
export async function POST(req: NextRequest) {
  const signature = req.headers.get("x-line-signature") || undefined;
  const rawBody = await req.text();

  // Production: ‡∏ï‡∏£‡∏ß‡∏à‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô, Dev: ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏™‡∏á‡πà‡∏≤‡∏¢
  const isDev = process.env.NODE_ENV !== "production";
  if (!isDev) {
    const ok = verifyLineSignature(rawBody, signature);
    if (!ok) return NextResponse.json({ error: "Invalid signature" }, { status: 401 });
  }

  const body = JSON.parse(rawBody || "{}");
  const events: any[] = body.events ?? [];

  for (const e of events) {
    try {
      // ‡πÄ‡∏Å‡πá‡∏ö userId/roomId/groupId ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö debug & push console
      const uid =
        e?.source?.userId || e?.source?.roomId || e?.source?.groupId || undefined;
      if (uid) trackUserId(uid).catch(() => {});

      // ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ text message
      if (e.type !== "message" || e.message?.type !== "text") continue;

      const userText: string = e.message.text || "";
      console.info("[webhook] text:", userText);

      // 0) Admin-only phrases ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö (‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
      if (includesAny(userText, ADMIN_ONLY_PHRASES)) {
        console.info("[skip] admin-only phrase detected. no bot reply.");
        continue;
      }

      // 1) Sensitive (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô/‡∏¢‡∏π‡∏™/‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£) ‚Üí ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      if (includesAny(userText, SENSITIVE_KEYWORDS)) {
        console.info("[reply] via Sensitive/Admin script");
        await lineReplyMessages(e.replyToken, [
          {
            type: "text",
            text:
              "‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ñ‡∏∏‡∏ì‡∏û‡∏µ‡πà‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üìû ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞",
          },
          {
            type: "text",
            text: "‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞ üôè",
          },
        ]);
        continue;
      }

      // 2) Intent router
      const intentMsgs = routeQuickAnswerToMessages(userText);
      if (intentMsgs && intentMsgs.length > 0) {
        console.info("[reply] via Router/Intent");
        await lineReplyMessages(e.replyToken, intentMsgs);
        continue;
      }

      // 3) Fallback ‚Üí ChatGPT (‡πÉ‡∏´‡πâ AI ‡∏ï‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
      console.info("[reply] via ChatGPT Fallback");
      const aiText = await askAI(userText, {
        brandName: BRAND_NAME,
        lineHandle: LINE_HANDLE,
      });

      const finalText =
        (aiText && aiText.trim()) ||
        "‡∏ô‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üôè";

      await lineReplyText(e.replyToken, finalText);
    } catch (err) {
      // ‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
      try {
        await lineReplyText(
          e.replyToken,
          "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞ üôè"
        );
      } catch {}
      console.error("[webhook error]", err);
    }
  }

  return NextResponse.json({ ok: true });
}

/** ---------------- GET: Health ---------------- */
export function GET() {
  return NextResponse.json({
    ok: true,
    brand: BRAND_NAME,
    handle: LINE_HANDLE,
    hint: "LINE ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å endpoint ‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ POST ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô",
  });
}